<!doctype html><html lang=zh-ch><head><title>runtime // AirChen Blog</title><link rel="shortcut icon" href=pikachu.ico><meta charset=utf-8><meta name=generator content="Hugo 0.104.3"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="AirChen"><meta name=description content><link rel=stylesheet href=https://blog.airchen-space.top/css/main.min.4a7ec8660f9a44b08c4da97c5f2e31b1192df1d4d0322e65c0dbbc6ecb1b863f.css><meta name=twitter:card content="summary"><meta name=twitter:title content="runtime"><meta name=twitter:description content="运行时的继续研究 + 笔记中的上半部分
@interface TObject : NSObject + (instancetype)getT; @end @implementation TObject + (instancetype)getT { return [TObject new]; } + (NSArray *)array { return [NSArray new]; } + (NSNumber *)number { return [NSNumber new]; } + (NSPredicate *)p { return [NSPredicate new]; } @end int main(int argc, const char * argv[]) { @autoreleasepool { _objc_autoreleasePoolPrint(); __auto_type obj = [TObject getT]; // autorelease _objc_autoreleasePoolPrint(); __auto_type predicate = [TObject p]; // autorelease _objc_autoreleasePoolPrint(); __auto_type arr = [TObject array]; // LTS _objc_autoreleasePoolPrint(); __auto_type num = [TObject number]; // LTS _objc_autoreleasePoolPrint(); } _objc_autoreleasePoolPrint(); return 0; } 测试返回值的内存管理 有些事放在 autorelease里，有些事在 LTS 里"><meta property="og:title" content="runtime"><meta property="og:description" content="运行时的继续研究 + 笔记中的上半部分
@interface TObject : NSObject + (instancetype)getT; @end @implementation TObject + (instancetype)getT { return [TObject new]; } + (NSArray *)array { return [NSArray new]; } + (NSNumber *)number { return [NSNumber new]; } + (NSPredicate *)p { return [NSPredicate new]; } @end int main(int argc, const char * argv[]) { @autoreleasepool { _objc_autoreleasePoolPrint(); __auto_type obj = [TObject getT]; // autorelease _objc_autoreleasePoolPrint(); __auto_type predicate = [TObject p]; // autorelease _objc_autoreleasePoolPrint(); __auto_type arr = [TObject array]; // LTS _objc_autoreleasePoolPrint(); __auto_type num = [TObject number]; // LTS _objc_autoreleasePoolPrint(); } _objc_autoreleasePoolPrint(); return 0; } 测试返回值的内存管理 有些事放在 autorelease里，有些事在 LTS 里"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.airchen-space.top/posts/runtime/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-12-03T17:19:51+08:00"><meta property="article:modified_time" content="2019-12-03T17:19:51+08:00"></head><body><header class=app-header><a href=https://blog.airchen-space.top/><img class=app-header-avatar src=/log.jpeg alt=AirChen></a><h1>AirChen Blog</h1><nav class=app-header-menu><a class=app-header-menu-item href=/>Home</a>
-
<a class=app-header-menu-item href=/daily/>Tags</a>
-
<a class=app-header-menu-item href=/about/>About</a></nav><p>以最放松的心态对待一切艰难</p><div class=app-header-social><a href=https://github.com/AirChen target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>My Github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=renzhichen2012@163.com target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-mail"><title>My Email</title><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>runtime</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Dec 3, 2019</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2 min read</div></div></header><div class=post-content><p>运行时的继续研究 + 笔记中的上半部分</p><pre tabindex=0><code>@interface TObject : NSObject
+ (instancetype)getT;
@end

@implementation TObject

+ (instancetype)getT {
    return [TObject new];
}

+ (NSArray *)array {
    return [NSArray new];
}

+ (NSNumber *)number {
    return [NSNumber new];
}

+ (NSPredicate *)p {
    return [NSPredicate new];
}

@end

int main(int argc, const char * argv[]) {
    @autoreleasepool {        
        _objc_autoreleasePoolPrint();

        __auto_type obj = [TObject getT]; // autorelease
        _objc_autoreleasePoolPrint();
        
        __auto_type predicate = [TObject p]; // autorelease
        _objc_autoreleasePoolPrint();
        
        __auto_type arr = [TObject array]; // LTS
        _objc_autoreleasePoolPrint();
        
        __auto_type num = [TObject number]; // LTS
        _objc_autoreleasePoolPrint();
        
    }
    _objc_autoreleasePoolPrint();
    
    return 0;
}
</code></pre><p>测试返回值的内存管理 有些事放在 autorelease里，有些事在 LTS 里</p><pre tabindex=0><code>NSObject *obj = [NSObject new];
        
__auto_type __weak weakO = obj;

unsigned int methodCount;
Method *methodList = class_copyMethodList([NSObject class], &amp;methodCount);
IMP lastImp = NULL;
SEL lastSel = NULL;
        
typedef NSString* (*fn)(id,SEL);

for (NSInteger i = 0; i &lt; methodCount; i++) {
    Method method = methodList[i];
    @autoreleasepool { // methodName 会被放入自动释放池
        NSString *methodName = [NSString stringWithCString:sel_getName(method_getName(method)) encoding:NSUTF8StringEncoding];
        if ([@&#34;description&#34; isEqualToString:methodName]) {
            lastImp = method_getImplementation(method);
            lastSel = method_getName(method);
//                    break;
        }
    }
}

fn f = (fn)lastImp;
for (int i = 0; i &lt; 10; i++) {
    NSString *des = f(weakO, lastSel);
    if (des) {
        NSLog(@&#34;---&gt; %@&#34;, des);
    } else {
        NSLog(@&#34;---&gt; in NSObject&#34;);
    }
}
        
free(methodList);

_objc_autoreleasePoolPrint();
</code></pre><p>测试 NSObject 的 description 方法 ，内存自动释放 貌似是CoreFoundation 中的实现会用自动释放池
<img src=images/image2.png alt=diag></p><p><img src=images/image3.png alt=diag>
由此可见 NSLog 中有 自己的自动释放池</p><p><a href=https://www.jianshu.com/p/9597ca7439ea>https://www.jianshu.com/p/9597ca7439ea</a> 关于 __weak 对象的引用，NSLog 中可能加入了 自动释放池</p><pre tabindex=0><code>__auto_type __weak wStr = @&#34;123&#34;;// signton

__auto_type __weak owStr = [NSString stringWithString:@&#34;123&#34;];
</code></pre><p>一个有警告，一个没有警告
字面量语法 => NSNumber NSString NSArray NSDictionary
<a href=https://stackoverflow.com/questions/48416192/assigning-object-to-weak-reference-in-objective-c>https://stackoverflow.com/questions/48416192/assigning-object-to-weak-reference-in-objective-c</a></p><p>NSString被存在于可执行文件中，不会被销毁，单例对象 singleton object</p><p><a href=https://draveness.me/autoreleasepool/>https://draveness.me/autoreleasepool/</a> 关于自动释放池</p><p>数据类型 id ，此处返回 BOOl 类型永远为 YES ，它指向了一个地址
<img src=images/image.png alt=diag></p><p>Tagged Pointer 的函数返回值放入 TLS，其他对象放 autorelease</p><p><a href=https://www.infoq.cn/article/deep-understanding-of-tagged-pointer>https://www.infoq.cn/article/deep-understanding-of-tagged-pointer</a>
苹果将Tagged Pointer引入，给 64 位系统带来了内存的节省和运行效率的提高。Tagged Pointer通过在其最后一个 bit 位设置一个特殊标记，用于将数据直接保存在指针本身中。因为Tagged Pointer并不是真正的对象，我们在使用时需要注意不要直接访问其 isa 变量。</p></div><div class=post-footer></div></article></main></body></html>